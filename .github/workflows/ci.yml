name: Multi-Variant Resume Release
permissions:
  contents: write
  actions: write

on:
  push:
    branches:
      - main

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      variants: ${{ steps.detect.outputs.variants }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 2

      - name: Detect changed variants
        id: detect
        run: |
          # Get list of changed files
          if [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ]; then
            # First push, build all variants (only directories with Resume.tex)
            CHANGED_VARIANTS=$(find Resume -mindepth 1 -maxdepth 1 -type d -exec test -f {}/Resume.tex \; -exec basename {} \; | jq -R -s -c 'split("\n")[:-1]')
          else
            CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
            # Only include directories that contain Resume.tex
            CHANGED_VARIANTS=$(echo "$CHANGED_FILES" | grep "^Resume/[^/]*/Resume.tex$" | cut -d'/' -f2 | sort -u | jq -R -s -c 'split("\n")[:-1] | map(select(length > 0))')
          fi
          
          if [ "$CHANGED_VARIANTS" = "[]" ] || [ -z "$CHANGED_VARIANTS" ]; then
            echo "variants=[]" >> $GITHUB_OUTPUT
          else
            echo "variants=$CHANGED_VARIANTS" >> $GITHUB_OUTPUT
          fi
          echo "Changed variants: $CHANGED_VARIANTS"

  build-and-release:
    needs: detect-changes
    if: needs.detect-changes.outputs.variants != '[]'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        variant: ${{ fromJson(needs.detect-changes.outputs.variants) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Compile LaTeX to PDF
        uses: docker://registry.gitlab.com/islandoftex/images/texlive:latest
        with:
          args: |
            sh -c "pdflatex -output-directory=./Resume/${{ matrix.variant }} ./Resume/${{ matrix.variant }}/Resume.tex && \
                   pdflatex -output-directory=./Resume/${{ matrix.variant }} ./Resume/${{ matrix.variant }}/Resume.tex"

      - name: Check if PDF was created
        run: |
          if [ ! -f ./Resume/${{ matrix.variant }}/Resume.pdf ]; then
            echo "Resume.pdf not found for ${{ matrix.variant }}!"
            exit 1
          fi

      - name: Read current version
        id: read_version
        run: |
          current_version=$(cat ./Resume/${{ matrix.variant }}/VERSION.txt)
          echo "current_version=$current_version" >> $GITHUB_OUTPUT

      - name: Increment version
        id: increment_version
        run: |
          IFS='.' read -r major minor patch <<< "${{ steps.read_version.outputs.current_version }}"
          
          if [ "$patch" -eq 9 ]; then
            patch=0
            minor=$((minor + 1))
            if [ "$minor" -eq 10 ]; then
              minor=0
              major=$((major + 1))
            fi
          else
            patch=$((patch + 1))
          fi
          
          new_version="$major.$minor.$patch"
          echo "$new_version" > ./Resume/${{ matrix.variant }}/VERSION.txt
          echo "new_version=$new_version" >> $GITHUB_OUTPUT

      - name: Rename PDF for release
        run: |
          version="${{ steps.increment_version.outputs.new_version }}"
          cp ./Resume/${{ matrix.variant }}/Resume.pdf ./RohanBatra.pdf

      - name: Update README.md
        run: |
          version="v${{ steps.increment_version.outputs.new_version }}"
          variant="${{ matrix.variant }}"
          
          # Update or add version line for this variant
          if grep -q "$variant Resume Version:" README.md; then
            sed -i "s/$variant Resume Version: .*/$variant Resume Version: $version/g" README.md
          else
            # Add new line after the Version header
            sed -i "/# Version/a $variant Resume Version: $version" README.md
          fi

      - name: Commit and Push Changes to Portfolio repo
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add ./Resume/${{ matrix.variant }}/VERSION.txt README.md
          git commit -m "Update ${{ matrix.variant }} version to v${{ steps.increment_version.outputs.new_version }}" || echo "No changes to commit"
          git pull --rebase
          git push || echo "No changes to push"

      - name: Checkout rohan_batra landing repo
        uses: actions/checkout@v3
        with:
          repository: rohanbatrain/rohan_batra
          ref: landing
          token: ${{ secrets.GH_TOKEN }}
          path: rohan_batra_landing

      - name: Push PDF to rohan_batra landing repo
        run: |
          version="${{ steps.increment_version.outputs.new_version }}"
          variant="${{ matrix.variant }}"
          
          # Create resume directory structure with version subdirectory
          mkdir -p rohan_batra_landing/resume/${{ matrix.variant }}/${version}
          
          # Copy PDF as RohanBatra.pdf in version directory
          cp ./Resume/${{ matrix.variant }}/Resume.pdf rohan_batra_landing/resume/${{ matrix.variant }}/${version}/RohanBatra.pdf
          
          # Also copy to root of variant directory (latest)
          cp ./Resume/${{ matrix.variant }}/Resume.pdf rohan_batra_landing/resume/${{ matrix.variant }}/RohanBatra.pdf
          
          # Generate navigation HTML for variant directory
          cat > rohan_batra_landing/resume/${{ matrix.variant }}/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8" />
            <meta name="viewport" content="width=device-width, initial-scale=1.0" />
            <title>${{ matrix.variant }} Resume - Rohan Batra</title>
            <meta name="description" content="Download Rohan Batra's ${{ matrix.variant }} resume" />
            <meta name="author" content="Rohan Batra" />
            <meta name="robots" content="index, follow" />
            <link rel="canonical" href="https://rohanbatra.in/resume/${{ matrix.variant }}/" />
            <style>
              :root {
                --bg-dark: #0f172a;
                --fg-light: #ffffff;
                --accent: #38bdf8;
                --muted: #94a3b8;
              }
              * { margin: 0; padding: 0; box-sizing: border-box; }
              html, body { height: 100%; }
              body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                background: radial-gradient(ellipse at top, #0f172a, #020617);
                color: var(--fg-light);
                display: flex;
                justify-content: center;
                align-items: center;
                text-align: center;
                padding: 2rem;
              }
              .container { max-width: 600px; }
              h1 {
                font-size: 2.5rem;
                font-weight: 800;
                margin-bottom: 0.5rem;
              }
              p {
                color: var(--muted);
                font-size: 1.125rem;
                margin-bottom: 2rem;
              }
              .links {
                display: flex;
                flex-direction: column;
                gap: 1rem;
                margin-bottom: 2rem;
              }
              .link-card {
                background: rgba(255, 255, 255, 0.05);
                backdrop-filter: blur(12px);
                border: 1px solid rgba(255, 255, 255, 0.1);
                padding: 1.25rem 2rem;
                border-radius: 0.75rem;
                text-decoration: none;
                color: var(--fg-light);
                font-weight: 600;
                font-size: 1rem;
                transition: transform 0.3s ease, box-shadow 0.3s ease;
              }
              .link-card:hover {
                transform: translateY(-4px);
                box-shadow: 0 0 20px rgba(56, 189, 248, 0.2);
                border-color: var(--accent);
              }
              .version-badge {
                display: inline-block;
                background: rgba(56, 189, 248, 0.2);
                color: var(--accent);
                padding: 0.25rem 0.75rem;
                border-radius: 1rem;
                font-size: 0.875rem;
                margin-top: 0.5rem;
              }
              footer {
                margin-top: 2rem;
                font-size: 0.875rem;
                color: var(--muted);
              }
            </style>
          </head>
          <body>
            <main class="container">
              <h1>${{ matrix.variant }} Resume</h1>
              <p>Rohan Batra's ${{ matrix.variant }} resume</p>
              <div class="version-badge">Current: v${version}</div>
              <nav class="links">
                <a class="link-card" href="RohanBatra.pdf" download>üìÑ Download Latest (v${version})</a>
                <a class="link-card" href="RohanBatra.pdf" target="_blank">üëÅÔ∏è View in Browser</a>
                <a class="link-card" href="../">‚Üê Back to All Resumes</a>
              </nav>
              <footer>
                &copy; 2025 Rohan Batra ‚Äî <a href="https://rohanbatra.in" style="color:inherit;">rohanbatra.in</a>
              </footer>
            </main>
          </body>
          </html>
          EOF
          
          # Generate main resume index.html with all variants
          cd rohan_batra_landing/resume
          VARIANTS_HTML=""
          for dir in */; do
            if [ -d "$dir" ] && [ -f "${dir}RohanBatra.pdf" ]; then
              variant_name="${dir%/}"
              version_file="${dir}../Resume/${variant_name}/VERSION.txt"
              if [ -f "../../Resume/${variant_name}/VERSION.txt" ]; then
                variant_version=$(cat "../../Resume/${variant_name}/VERSION.txt" 2>/dev/null || echo "unknown")
              else
                variant_version="unknown"
              fi
              VARIANTS_HTML="${VARIANTS_HTML}<a class=\"resume-card\" href=\"${variant_name}/\"><div class=\"resume-icon\">üìã</div><div class=\"resume-title\">${variant_name}</div><div class=\"resume-version\">v${variant_version}</div></a>"
            fi
          done
          
          # Create index.html from template
          cat > index.html << 'MAINEOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8" />
            <meta name="viewport" content="width=device-width, initial-scale=1.0" />
            <title>Resumes - Rohan Batra</title>
            <meta name="description" content="Download Rohan Batra's professional resumes" />
            <style>
              :root { --bg-dark: #0f172a; --fg-light: #ffffff; --accent: #38bdf8; --muted: #94a3b8; }
              * { margin: 0; padding: 0; box-sizing: border-box; }
              html, body { height: 100%; }
              body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                background: radial-gradient(ellipse at top, #0f172a, #020617);
                color: var(--fg-light);
                display: flex;
                justify-content: center;
                align-items: center;
                text-align: center;
                padding: 2rem;
              }
              .container { max-width: 700px; }
              h1 { font-size: 3rem; font-weight: 800; margin-bottom: 0.5rem; }
              p { color: var(--muted); font-size: 1.25rem; margin-bottom: 2.5rem; }
              .resume-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                gap: 1.5rem;
                margin-bottom: 2rem;
              }
              .resume-card {
                background: rgba(255, 255, 255, 0.05);
                backdrop-filter: blur(12px);
                border: 1px solid rgba(255, 255, 255, 0.1);
                padding: 2rem;
                border-radius: 1rem;
                text-decoration: none;
                color: var(--fg-light);
                transition: transform 0.3s ease, box-shadow 0.3s ease;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 1rem;
              }
              .resume-card:hover {
                transform: translateY(-4px);
                box-shadow: 0 0 20px rgba(56, 189, 248, 0.2);
                border-color: var(--accent);
              }
              .resume-icon { font-size: 2.5rem; }
              .resume-title { font-size: 1.5rem; font-weight: 700; }
              .resume-version { font-size: 0.875rem; color: var(--muted); }
              footer { margin-top: 3rem; font-size: 0.875rem; color: var(--muted); }
            </style>
          </head>
          <body>
            <main class="container">
              <h1>üìÑ Resume Collection</h1>
              <p>Choose a resume variant</p>
              <div class="resume-grid">
          MAINEOF
          
          echo "$VARIANTS_HTML" >> index.html
          
          cat >> index.html << 'MAINEOF2'
              </div>
              <footer>
                &copy; 2025 Rohan Batra ‚Äî <a href="https://rohanbatra.in" style="color:inherit;">rohanbatra.in</a>
              </footer>
            </main>
          </body>
          </html>
          MAINEOF2
          
          cd ..
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add resume/
          git commit -m "Update $variant resume to version $version" || echo "No changes to commit"
          git push || echo "No changes to push"

      - name: Create Release
        run: |
          variant="${{ matrix.variant }}"
          version="v${{ steps.increment_version.outputs.new_version }}"
          tag="${variant,,}-${version}"
          
          # Create and push tag
          git tag -a "$tag" -m "$variant Resume Release $version" || echo "Tag exists"
          git push origin "$tag" || echo "Tag already pushed"
          
          # Create release
          gh release create "$tag" \
            ./RohanBatra.pdf \
            --title "$variant Resume Release $version" \
            --notes "Release of $variant resume version $version"
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
