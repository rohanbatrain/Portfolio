name: Multi-Variant Resume Release
permissions:
  contents: write
  actions: write

on:
  push:
    branches:
      - main

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      variants: ${{ steps.detect.outputs.variants }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 2

      - name: Detect changed variants
        id: detect
        run: |
          # Get list of changed files
          if [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ]; then
            # First push, build all variants
            CHANGED_VARIANTS=$(ls -d Resume/*/ | xargs -I {} basename {} | jq -R -s -c 'split("\n")[:-1]')
          else
            CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
            CHANGED_VARIANTS=$(echo "$CHANGED_FILES" | grep "^Resume/" | cut -d'/' -f2 | sort -u | jq -R -s -c 'split("\n")[:-1] | map(select(length > 0))')
          fi
          
          if [ "$CHANGED_VARIANTS" = "[]" ] || [ -z "$CHANGED_VARIANTS" ]; then
            echo "variants=[]" >> $GITHUB_OUTPUT
          else
            echo "variants=$CHANGED_VARIANTS" >> $GITHUB_OUTPUT
          fi
          echo "Changed variants: $CHANGED_VARIANTS"

  build-and-release:
    needs: detect-changes
    if: needs.detect-changes.outputs.variants != '[]'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        variant: ${{ fromJson(needs.detect-changes.outputs.variants) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Compile LaTeX to PDF
        uses: docker://registry.gitlab.com/islandoftex/images/texlive:latest
        with:
          args: |
            sh -c "pdflatex -output-directory=./Resume/${{ matrix.variant }} ./Resume/${{ matrix.variant }}/Resume.tex && \
                   pdflatex -output-directory=./Resume/${{ matrix.variant }} ./Resume/${{ matrix.variant }}/Resume.tex"

      - name: Check if PDF was created
        run: |
          if [ ! -f ./Resume/${{ matrix.variant }}/Resume.pdf ]; then
            echo "Resume.pdf not found for ${{ matrix.variant }}!"
            exit 1
          fi

      - name: Read current version
        id: read_version
        run: |
          current_version=$(cat ./Resume/${{ matrix.variant }}/VERSION.txt)
          echo "current_version=$current_version" >> $GITHUB_OUTPUT

      - name: Increment version
        id: increment_version
        run: |
          IFS='.' read -r major minor patch <<< "${{ steps.read_version.outputs.current_version }}"
          
          if [ "$patch" -eq 9 ]; then
            patch=0
            minor=$((minor + 1))
            if [ "$minor" -eq 10 ]; then
              minor=0
              major=$((major + 1))
            fi
          else
            patch=$((patch + 1))
          fi
          
          new_version="$major.$minor.$patch"
          echo "$new_version" > ./Resume/${{ matrix.variant }}/VERSION.txt
          echo "new_version=$new_version" >> $GITHUB_OUTPUT

      - name: Rename PDF for release
        run: |
          cp ./Resume/${{ matrix.variant }}/Resume.pdf ./RohanBatra-${{ matrix.variant }}.pdf

      - name: Update README.md
        run: |
          version="v${{ steps.increment_version.outputs.new_version }}"
          variant="${{ matrix.variant }}"
          
          # Update or add version line for this variant
          if grep -q "$variant Resume Version:" README.md; then
            sed -i "s/$variant Resume Version: .*/$variant Resume Version: $version/g" README.md
          else
            # Add new line after the Version header
            sed -i "/# Version/a $variant Resume Version: $version" README.md
          fi

      - name: Commit and Push Changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add ./Resume/${{ matrix.variant }}/VERSION.txt README.md
          git commit -m "Update ${{ matrix.variant }} version to v${{ steps.increment_version.outputs.new_version }}" || echo "No changes to commit"
          git pull --rebase
          git push || echo "No changes to push"

      - name: Create Release
        run: |
          variant="${{ matrix.variant }}"
          version="v${{ steps.increment_version.outputs.new_version }}"
          tag="${variant,,}-${version}"
          
          # Create and push tag
          git tag -a "$tag" -m "$variant Resume Release $version" || echo "Tag exists"
          git push origin "$tag" || echo "Tag already pushed"
          
          # Create release
          gh release create "$tag" \
            ./RohanBatra-${{ matrix.variant }}.pdf \
            --title "$variant Resume Release $version" \
            --notes "Release of $variant resume version $version"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
